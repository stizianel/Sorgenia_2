<root>
	<queries>
	<FactorAggregator>
		<mainSelect ><![CDATA[
        select c.DBI_ORIGINAL_KEY_PR,  --0
        c.cpod,                                    --1 
        a.operando,                                 --2
         CASE WHEN A.OPERANDO='EF_SC_APP' THEN  GET_AB_EF_SC_APP(b.operando,a.ctar1,c.d_valido_dal,data_validita)
        ELSE get_ab2(b.operando,a.ctar1,c.d_valido_dal,data_validita) END CASE,--3 
        get_bis2(b.operando,a.ctar1,c.d_valido_dal,c.d_valido_al,data_validita_al),--4
        CASE WHEN A.OPERANDO='EF_RES' THEN DEC_CTFOR(C.CTFOR)when a.operando='EF_SC_APP' then prezzo ELSE valori END CASE,                               --5  
        nvl(prezzo,0) ,                             --6
        b.id_operando,                               --7
        DEC_CTFOR(C.CTFOR)
        from  z_prodotto_operando a, z_anagrafica_operandi b,
        DBI_USER.ifc_sap_anagrcontrele C ,
        DBI_USER.ifc_sap_punti_fornitura d
        where
       a.acquisizione= c.cfreq
         and d.dbi_punto_key= c.DBI_ORIGINAL_KEY_PR
         and a.ctar1=c.ctar1
        --and c.DBI_ORIGINAL_KEY_PR IN (select cncon from z_test_contratti)-- where note = 'lotto 30')
        and a.operando = b.operando 
        and C.Dbi_Original_Key_Pr in ('PR2208613','PR3433147')
        and tipo = 'FACTOR'
            and c.d_valido_dal=d.valid_from
      and c.d_valido_al=d.valid_until
        group by 
        c.DBI_ORIGINAL_KEY_PR, 
        c.cpod, 
        a.operando, prezzo,
         GET_AB_EF_SC_APP(b.operando,a.ctar1,c.d_valido_dal,data_validita),
         get_ab2(b.operando,a.ctar1,c.d_valido_dal,data_validita) ,--3 
        get_bis2(b.operando,a.ctar1,c.d_valido_dal,c.d_valido_al,data_validita_al),--4   
        valori, c.d_valido_dal,
        nvl(prezzo,0),
        b.id_operando ,DEC_CTFOR(C.CTFOR)
        order by c.d_valido_dal  
        ]]></mainSelect>
		
		     <insertTable name='FACTS_F_FACTOR' truncate = 'True' break_index='' >
		     <field name='LEGACY'  index='0' />
		     <field name='TIPO'    constant_value='F_FACT' />
		     <field name='OPERAND' index = '2'  />
		     <field name='SAISON'  constant_value='' />
		     <field name='PROG'    index= '7' />
		     <field name='CPOD'   index= '1'/>
		   </insertTable> 
		   <insertTable name='FACTS_V_FACTOR' truncate = 'True' break_index='' >
		     <field name='LEGACY'    index='0' />
		     <field name='TIPO'       constant_value='V_FACT' />
		     <field name='TARIFART'   constant_value='' />
		      <field name='FACTOR'     index='5' />
		     <field name='KONDIGR'    constant_value='' />
		     <field name='AB'         index='3' />
		     <field name='BIS'        index='4' />
		     <field name='PROG'       index= '7' /> 
		     <field name='CPOD'   index= '1'/>
		     </insertTable> 
		
	</FactorAggregator>
	<FactorExtractor>
		<mainSelect ><![CDATA[
		SELECT
               FACTS_KEY.LEGACY,  --0
               FACTS_KEY.TIPO,--1
               FACTS_KEY.ANLAGE, --2
               FACTS_KEY.BIS, --3
               facts_f_factor.legacy, --4
               facts_f_factor.tipo, --5
               facts_f_factor.operand, --6
               facts_f_factor.saison, --7
               facts_f_factor.prog, --8
               facts_v_factor.legacy, --9
               facts_v_factor.tipo, --10
               facts_v_factor.ab, --11
               facts_v_factor.bis, --12
               facts_v_factor.factor, --13
               facts_v_factor.tarifart, --14
               facts_v_factor.kondigr, --15
              facts_v_factor.prog --16
              from facts_key,facts_f_factor,facts_v_factor
              where facts_key.legacy = facts_f_factor.legacy
              and facts_v_factor.legacy=facts_key.legacy
              and facts_f_factor.legacy=facts_v_factor.legacy
              and facts_f_factor.prog=facts_v_factor.prog
              order by facts_f_factor.prog
                 ]]></mainSelect>
         <csvLine line_index='00' break_index='0'  field_start_index='0'  field_end_index='3' >
          </csvLine>
         <csvLine line_index='01' break_index=''   field_start_index='4'  field_end_index='7'   >
         </csvLine>       
         <csvLine line_index='02' break_index=''   field_start_index='9'  field_end_index='15'  >
         </csvLine>   
         <ende field_index='0' />
	</FactorExtractor>
	</queries>
</root>

