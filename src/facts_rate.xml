<root>
	<queries>
	<RateAggregator>
		<mainSelect ><![CDATA[
        SELECT /*+ ORDERED FULL(i) */
       v.Dbi_Original_Key_Pr , --0
       v.Dbi_Original_Key_Pr, --1
       a.Operando,
	   Get_Ab2(b.Operando, a.Ctar1, v.cdsti, Data_Validita), --3
      Get_Bis2(b.Operando,a.Ctar1,v.cdsti,v.cdces,Data_Validita_Al) , --4
	  Get_Param_Valori_Tarifart(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr) , --5
    Get_Param_Prezzo_Kondigr(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr,v.d_valido_dal), --6
       b.Id_Operando
  FROM z_Test_Contratti                     i
     , Dbi_User.Ifc_Sap_Anagrcontrele       v
     , Dbi_User.Ifc_Sap_Fornitura_Ee_Config f
     , Dbi_User.Ifc_Sap_Punti_Fornitura     d
     , z_Prodotto_Operando                  a
     , z_Anagrafica_Operandi                b
     , Dbi_User.Ifc_Sap_Anagrindirizzi      g    
     , v_Indirizzi                          l    
 WHERE i.Note = 'lotto 24'
   AND v.Dbi_Original_Key_Pr = i.Cncon            
   AND to_char(f.d_valido_dal,'yyyymmdd')= to_char(v.d_valido_dal,'yyyymmdd')
   and to_char(f.d_valido_al,'yyyymmdd')= to_char(v.d_valido_al,'yyyymmdd')
   AND f.Dbi_Cd_Contratto = v.Ccontratto          --
   AND v.Dbi_Original_Key_Pr=g.Dbi_Original_Key   
  AND to_char(d.valid_from,'yyyymmdd')=to_char(v.d_valido_dal,'yyyymmdd')
   And to_char(d.valid_until,'yyyymmdd')=to_char(v.d_valido_al,'yyyymmdd')
   AND a.Operando = b.Operando
   AND Tipo = 'RATE TYPE' 
   AND l.Indprog = g.Indprog
    AND a.Acquisizione = v.Cfreq
   AND v.Ctar1 = a.Ctar1
   AND v.Cfreq = d.Frequenza_Misura
   AND a.Prodotto = 'STD_TANDEM'
GROUP BY v.Dbi_Original_Key_Pr , --0
       v.Dbi_Original_Key_Pr, --1
       a.Operando,v.d_valido_dal,v.d_valido_al,v.cdsti,v.cdces,
	   Get_Ab2(b.Operando, a.Ctar1, v.cdsti, Data_Validita), --3
      Get_Bis2(b.Operando,a.Ctar1,v.cdsti,v.cdces,Data_Validita_Al) , --4
	  Get_Param_Valori_Tarifart(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr) , --5
       Get_Param_Prezzo_Kondigr(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr,v.d_valido_dal), 
       b.Id_Operando,a.ctar1,a.Acquisizione , v.Cfreq
       union
               SELECT /*+ ORDERED FULL(i) */
       v.Dbi_Original_Key_Pr , --0
       v.Dbi_Original_Key_Pr, --1
       a.Operando,
	   Get_Ab2(b.Operando, a.Ctar1, v.cdsti, Data_Validita), --3
      Get_Bis2(b.Operando,a.Ctar1,v.cdsti,v.cdces,Data_Validita_Al) , --4
	  Get_Param_Valori_Tarifart(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr) , --5
    Get_Param_Prezzo_Kondigr(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr,v.d_valido_dal), --6
       b.Id_Operando
  FROM z_Test_Contratti                     i
     , Dbi_User.Ifc_Sap_Anagrcontrele       v
     , Dbi_User.Ifc_Sap_Fornitura_Ee_Config f
     , Dbi_User.Ifc_Sap_Punti_Fornitura     d
     , z_Prodotto_Operando                  a
     , z_Anagrafica_Operandi                b
     , Dbi_User.Ifc_Sap_Anagrindirizzi      g    
     , v_Indirizzi                          l    
 WHERE i.Note = 'lotto 24'
   AND v.Dbi_Original_Key_Pr = i.Cncon            
   AND to_char(f.d_valido_dal,'yyyymmdd')= to_char(v.d_valido_dal,'yyyymmdd')
   and to_char(f.d_valido_al,'yyyymmdd')= to_char(v.d_valido_al,'yyyymmdd')
   AND f.Dbi_Cd_Contratto = v.Ccontratto          --
   AND v.Dbi_Original_Key_Pr=g.Dbi_Original_Key   
  AND to_char(d.valid_from,'yyyymmdd')=to_char(v.d_valido_dal,'yyyymmdd')
   And to_char(d.valid_until,'yyyymmdd')=to_char(v.d_valido_al,'yyyymmdd')
   AND a.Operando = b.Operando
   AND Tipo = 'RATE TYPE' 
   AND l.Indprog = g.Indprog
   AND v.Ctar1 = a.Ctar1
   AND v.Cfreq = d.Frequenza_Misura
   AND a.Prodotto = 'STD_TANDEM'
GROUP BY v.Dbi_Original_Key_Pr , --0
       v.Dbi_Original_Key_Pr, --1
       a.Operando,v.d_valido_dal,v.d_valido_al,v.cdsti,v.cdces,
	   Get_Ab2(b.Operando, a.Ctar1, v.cdsti, Data_Validita), --3
      Get_Bis2(b.Operando,a.Ctar1,v.cdsti,v.cdces,Data_Validita_Al) , --4
	  Get_Param_Valori_Tarifart(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr) , --5
       Get_Param_Prezzo_Kondigr(a.Operando,a.Ctar1,Dec_Stagruver(v.Ctfor),Dec_Spebene(v.Crete, f.n_Tensione),TRIM(TO_CHAR(f.n_Potenza_Imp)),'0',l.Indprov,l.Indccom,f.Cd_Tariffa_Distr,v.d_valido_dal), 
       b.Id_Operando,a.ctar1,a.Acquisizione , v.Cfreq
          
     ]]></mainSelect>
		
		     <insertTable name='FACTS_F_RATE_TYPE' truncate = 'True' break_index='' >
		     <field name='LEGACY' index='0' />
		     <field name='TIPO' constant_value='F_RATE' />
		     <field name='OPERAND' index = '2'  />
		     <field name='SAISON' constant_value='' />
		     <field name='PROG'   index= '7'/>
		   </insertTable> 
		   <insertTable name='FACTS_V_RATE_TYPE' truncate = 'True' break_index='' >
		      <field name='LEGACY' index='0' />
		     <field name='TIPO' constant_value='V_RATE' />
		     <field name='AB'   index='3' />
		     <field name='BIS' index='4' />
		      <field name='TARIFART' index='5' />
		     <field name='KONDIGR' index='6' />
		     <field name='PROG'  index ='7' />
		     </insertTable> 
		
	</RateAggregator>
	<RateExtractor>
		<mainSelect ><![CDATA[
		SELECT
               FACTS_KEY.LEGACY||facts_f_rate_type.operand||facts_v_rate_type.ab,  --0
               FACTS_KEY.TIPO,--1
               FACTS_KEY.ANLAGE, --2
               FACTS_KEY.BIS, --3
               facts_f_rate_type.legacy||facts_f_rate_type.operand||facts_v_rate_type.ab, --4
               facts_f_rate_type.tipo, --5
               facts_f_rate_type.operand, --6
               facts_f_rate_type.saison, --7
               facts_f_rate_type.prog, --8
               facts_v_rate_type.legacy||facts_f_rate_type.operand||facts_v_rate_type.ab, --9
               facts_v_rate_type.tipo, --10
                facts_v_rate_type.ab, --11
               facts_v_rate_type.bis, --12
               facts_v_rate_type.tarifart, --13
               facts_v_rate_type.kondigr, --14
              facts_v_rate_type.prog --15
              from facts_key,facts_f_rate_type,facts_v_rate_type
              where facts_key.legacy = facts_f_rate_type.legacy
              and facts_v_rate_type.legacy=facts_key.legacy
              and facts_f_rate_type.legacy=facts_v_rate_type.legacy
              and facts_f_rate_type.prog=facts_v_rate_type.prog
              order by facts_f_rate_type.prog
           ]]></mainSelect>
         <csvLine line_index='00' break_index='0'  field_start_index='0'  field_end_index='3' >
          </csvLine>
         <csvLine line_index='01' break_index=''   field_start_index='4'  field_end_index='7'   >
         </csvLine>       
         <csvLine line_index='02' break_index=''   field_start_index='9'  field_end_index='14'  >
         </csvLine>   
         <ende field_index='0' />
	</RateExtractor>
	</queries>
</root>

